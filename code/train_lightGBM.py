# Welcome to your new notebook
# Type here in the cell editor to add code!
import pyspark
spark = pyspark.sql.SparkSession.builder.appName("MyApp") \
            .config("spark.jars.packages", "com.microsoft.azure:synapseml_2.12:1.0.1") \
            .getOrCreate()
from synapse.ml.lightgbm import LightGBMClassifier
from synapse.ml.lightgbm import LightGBMClassificationModel

# 初始化 Spark



# read data
train_data = spark.read.parquet("Microsoft_Malware_Detection/data/clean_train_data.parquet")
test_data = spark.read.parquet("Microsoft_Malware_Detection/data/clean_test_data.parquet")

# config LightGBM classifier
lgbm = LightGBMClassifier(
    featuresCol='features',
    labelCol='HasDetections', # 替换 'label' 为你的标签列名称
    objective='binary', # 根据你的需求选择适当的目标（例如 'binary' 或 'multiclass'）
    numIterations=100,
    learningRate=0.1
)
# train
model = lgbm.fit(train_data)
# predict
predictions = model.transform(test_data)
# save
predictions.show()
model.write().save("Microsoft_Malware_Detection/models/lightGBM_model")
predictions = predictions.select("MachineIdentifier", "prediction")
final_predictions = predictions.withColumnRenamed("prediction", "HasDetections")

final_predictions.coalesce(1).write.csv("Microsoft_Malware_Detection/submissions/lightGBM_model_prediction.csv", header=True)



# 关闭 Spark 会话
spark.stop()